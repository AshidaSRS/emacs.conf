#!/bin/bash 


#load enviroment
#sh /home/anabel/.confTriquiPPS
export MINIENTREGA_FECHALIMITE="2016-10-10"

#help
    if [ $# -ne 1 ] ; then
        echo "minientrega.sh: Error(EX_USAGE), uso incorrecto del mandato. "Success""
        echo "minientrega.sh+ «Argumentos incorrectos»"
        exit 64
    elif [[ $1 == "-h" || $1 == "--help" ]] ; then
        echo "minientrega.sh: Uso: «Ayuda»"
        echo "Minientrga.sh: «Este programa te comprueba si se acepta la práticminientrega.sh+ «No se ha puesto un argumento correcto»"
  exit 0
    fi

#MINIENTREGA_CONF
if [ ! -d $MINIENTREGA_CONF ] || [ ! -e $MINIENTREGA_CONF ] || [ ! -r $MINIENTREGA_CONF ] ; then
    exit 64
fi
if [ ! -e $MINIENTREGA_CONF/$1 ] || [ ! -f $MINIENTREGA_CONF/$1 ] || [ ! -r $MINIENTREGA_CONF/$1 ] ; then
    exit 66
fi

source $MINIENTREGA_CONF/$1

#fecha
probando='[0-9]{4}-[0-1][0-9]-[0-3][0-9]'
if  [[ ! $MINIENTREGA_FECHALIMITE =~ $probando ]]; then
    exit 66
fi
    todate=$(date -d $fecha +%S)
    cons=$(date -d 2016-11-08 +%s)
    if [ $todate -gt $cons ] ; then
  exit 66
    fi
   
#ficheros
    for fichero in $MINIENTREGA_FICHEROS ; do
        if  [[ ! -e ./$fichero || ! -r ./$fichero ]] ; then 
      exit 66
  fi
    done

#destino
if [ ! -e $MINIENTREGA_DESTINO ] || [ ! -w $MINIENTREGA_DESTINO ] ; then
    exit 73
fi

if [ ! -d $MINIENTREGA_DESTINO/$USER ] ; then
    exit 73

if [ -e $MINIENTREGA_DESTINO/$USER ] && [ ! -w $MINIENTREGA_DESTINO/$USER ] ; then
    exit 73
fi
 
 if [ ! -e $MINIENTREGA_DESTINO/$USER ] ; then
  mkdir $MINIENTREGA_DESTINO/$USER
fi

#Copiamos ficheros
for fichero in $MINIENTREGA_FICHEROS ; do
    cp ./$fichero $MINIENTREGA_DESTINO/$USER
done

exit 0
